# 027 版本更新手册



## TIPS

注意！本次更新变动极大，包括大量的材质改变以及大量的API改动，且改动不可兼容以前版本。

本更新手册只兼容022/023/024/025/026的项目升级到027，026之前的报错解决请参见文档：[026编辑器新增严格编译功能下报错的解决方案 | 产品手册 ](https://docs.ark.online/ReleaseNote/Special/026编辑器新增严格编译功能下报错的解决方案.html#情况1处理方案)

## 操作手册共分为三个大部分：

- 更新升级程序自动处理大部分更新逻辑
- 部分无法自动处理的手动处理操作文档
- 运行测试，查看表现以及逻辑，进行更新微调

## 更新升级程序自动处理流程：

<video controls src="https://arkimg.ark.online/027%E8%87%AA%E5%8A%A8%E5%8D%87%E7%BA%A7%E7%94%9F%E6%88%90%E7%89%88.mp4"></video>

​														**演示视频**

1. 双击项目选择升级，弹出版本升级提示界面
2. 点击版本升级提示界面的**我知道了**按钮（可以点击Release Note蓝字手动打开更新信息网页），弹出027升级重要提示
3. 在升级前，**请认真阅读升级提示信息**，阅读完成后，点击027升级重要提示界面的**我知道了**按钮，此时会自动弹出Release Note更新信息网页，此时项目已经开始升级了，根据项目规模及电脑配置的不同，升级时间将持续3-20分钟左右
4. 升级完成后将弹出**AssetLog**日志文件，该日志位于升级项目的**根目录下**，其中描述了升级的后续需要手动处理的信息，在完全升级完成前，请不要删除它
5. 升级完成项目后，会自动打开项目，如果项目文件夹存在非法字符（如 . , ` ~ = + !等，以及多数中文符号），会导致打开项目失败，解决办法就是在文件夹修改名字时去掉这些非法字符即可（**特别注意：千万不要修改了文件夹名字，又在编辑器本地游戏那儿重命名项目名字，不要这么操作！**）

![img](https://arkimg.ark.online/1695808097882-7.webp)

​														项目文件夹名字带有“.”

![img](https://arkimg.ark.online/1695808097882-1.webp)

​												自动打开项目时会出现非法字符提示

1. 自动打开过程中有可能出现卡住的情况，重启编辑器再打开该项目就行。
2. 部分项目升级完成打开时，可能出现RollupError提示，这时候直接跳过修改API即可，修改完成后再次打开项目将不会再有类似提示：

RollupError: Unexpected token(Note that you need plugins to import files that are not JavaScript)

![img](https://arkimg.ark.online/1695808097882-2.webp)

​															报错提示

<video controls src="https://arkimg.ark.online/%E9%83%A8%E5%88%86%E9%A1%B9%E7%9B%AE%E5%8D%87%E7%BA%A7%E5%90%8E%E5%BC%B9%E5%87%BARollupError%E7%94%9F%E6%88%90%E7%89%88.mp4"></video>



**项目自动备份**

当选择升级，走升级流程后，我们的项目会自动备份到**\MetaWorldSaved\Saved\MetaWorld\Project\Backup**目录下，多次升级同名项目，还会在该目录下保存多份备份文件，后缀是选择升级的时间

![img](https://arkimg.ark.online/1695808097882-3.webp)

## 手动处理部分参考手册：

### API替换

- 双击脚本打开VSCode，逐步排查项目中报错的脚本。

  - VSCode打开项目中的ModifiedStaticAPI.ts全局替换部分，可以关闭编辑器提升一下性能
    1. 需要注意F2后等待一段时间，如下视频中一条移动的蓝色横线就是等待中
    2. 如果F2等待时间过久，可以先关闭VSCode，然后运行VSCode.exe重新打开继续替换

  <video controls src="https://arkimg.ark.online/F2%E6%9B%BF%E6%8D%A2%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E7%89%88.mp4"></video>

  ​													 替换演示

  - **F2**（或鼠标右键点击**重命名符号**）批量替换全局匹配项，注意**两次**替换过程都是通过**F2**进行，替换框打开后要按**回车键**来完成替换。
  - 部分没有做类型转换的代码可能会涉及到接口没有更新到并且编译时不会报错，运行时也没有在客户端1的日志里显示报错，代码也没执行下去，需要注意查看MW_Client.log和MW_Server.log，检查TypeError相关报错提醒

  ![img](https://arkimg.ark.online/1695808097882-4-1695808630475-22.webp)

​										（any类型，编译时并不会差距到根本没有onEnter和onLeave）

<video controls src="https://arkimg.ark.online/API%E6%9B%BF%E6%8D%A2%E7%94%9F%E6%88%90%E7%89%88.mp4"></video>

​														API替换部分案例

- 推荐优先删除项目里代码中的preloadAssets（不需要替换game.js、All_Json、Local_Asset_List、tsconfig.tsbuildinfo、.project文件、NewLevel.level、.prefab文件中的preloadAssets），有些代码多层继承，免得找起来麻烦，浪费时间
- 这个部分较多情况是无法自动替换的API变动，可以参考完整的API变动列表文档来替换对应API的使用：[0.27.0.0版本API变动映射表](https://meta.feishu.cn/wiki/AkDmwryhWitKsNkRZx1cKw7OnX9) ，将报错的API在文档中搜索，应该都能找到对应的变动说明以及替代方案。
- API变动后的注意事项可以查看[0.27API修改注意事项](https://meta.feishu.cn/docx/Q8p6d2yPCobgboxb8xecEAXHnJc) ，里面有更新后在后续编写代码中需要注意的部分。
- 若没有搜索到可以及时在论坛反馈，发帖时可以在帖子标题前方添加“【027更新问题】”我们会优先查看处理。

### 资源更新

- 要检查几个地方的问题：

  - 场景表现，因为更新了部分资源、材质，会导致项目中某些地方出现资源没有了、材质表现不同等情况，需要进行更换材质或者更换物体，这个部分每个项目不同，所以寻找对应的替换材质和替换物体也不同，无法给出准确的参考意见，下边会给出一些示例供大家参考

    ####  不规范资源替换

    <video controls src="https://arkimg.ark.online/%E6%89%8B%E5%8A%A8%E6%9B%BF%E6%8D%A2%E5%BA%9F%E5%BC%83%E8%B5%84%E6%BA%90%E7%94%9F%E6%88%90%E7%89%881.mp4"></video>

    ​														资源替换实际案例

    #### 废弃材质替换

    <video controls src="https://arkimg.ark.online/%E6%89%8B%E5%8A%A8%E6%9D%90%E8%B4%A8%E6%9B%BF%E6%8D%A2%E7%94%9F%E6%88%90%E7%89%88.mp4"></video>

    ​													材质替换实际案例

    - 除了材质变化以外，少部分项目可能还会有一些材质丢失的情况（材质废弃了），有明显丢失的可以自行找替换的材质。
    - 若肉眼未发现丢失的，可以根据升级工具里的提示来对应查找

    ![img](https://arkimg.ark.online/1695808097882-5-1695809495259-24.webp)

     											 更新工具列出的废弃材质

    ![img](https://arkimg.ark.online/1695808097882-6-1695809512554-26.webp)

    ​									主视口显示的废弃资源效果（黑色底+红色Deprecated文字）

### 预制体无法通过guid查找

预制体无法通过guid查找，因此涉及资源查找或代码写法都要注意，不要在预制体中使用

<video controls src="https://arkimg.ark.online/%E9%A2%84%E5%88%B6%E4%BD%93%E6%97%A0%E6%B3%95%E9%80%9A%E8%BF%87guid%E6%9F%A5%E6%89%BE%E7%94%9F%E6%88%90%E7%89%88.mp4"></video>

## 运行项目测试微调

- 将上面操作都做完之后，运行项目测试看看
- 运行起来后，查看各个场景的物体材质情况和逻辑表现，处理细节微调问题，可能出现的问题，请参考文档：[0.27.0.0版本运行时问题记录](https://meta.feishu.cn/wiki/H19RwSXPxi44aIkVaP1c913dnbc?table=tblZxIm4DamdiZR1&view=vewUN3XmLw) 
- 若都没有问题后，删除根目录下的“**027修改记录.txt**”和"**AssetLog.txt**"文件
- 到此，027的升级就圆满结束了

## 最后

升级过程中有任何意外情况、文档中没有提到的问题、现象和文档不一样等等，都可以去https://forum.ark.online/论坛反馈，发帖时帖子标题前方添加“【027更新问题】”我们会优先查看处理！
